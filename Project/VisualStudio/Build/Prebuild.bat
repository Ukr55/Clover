setlocal enableextensions enabledelayedexpansion

echo Cleaning build stage %EfiBuildStage% ...
rmdir /s /q "%EfiBuildStage%" >NUL 2>NUL
echo Cleaning output stage %EfiOutputStage% ...
rmdir /s /q "%EfiOutputStage%" >NUL 2>NUL

call "%EfiProjectBuildTools%\SetVersion.bat"

echo Project name: %EfiProjectName%
echo Project arch: %EfiProjectArch%
echo Project debug: %EfiProjectDebug%
echo Project major version: %EfiProjectMajorVersion%
echo Project minor version: %EfiProjectMinorVersion%
echo Project update version: %EfiProjectUpdateVersion%
echo Project version tag: %EfiProjectVersionTag%
echo Project version commit: %EfiProjectVersionHash%
echo Project version: %EfiProjectVersion% (%EfiProjectFullVersion%)
echo Project virtual memory: %EfiMemoryVirtual%
echo Project virtual memory mixed IA32/X64 firmware safe: %EfiMemoryVirtualFirmwareSafe%
echo Project serial disable: %EfiSerialDisable%

set _include=%EfiBuildStage%\Include\Uefi\Version.h

if not exist "%_include%" (
  echo Generating version header "%_include%" ...
  mkdir "%EfiBuildStage%\Include\Uefi"
  echo // This version header is autogenerated by prebuild for every build so changing this file will not be persisent> %_include%
  echo #ifndef __PROJECT_VERSION_HEADER__>> "%_include%"
  echo #define __PROJECT_VERSION_HEADER__>> "%_include%"
  echo #define EFI_PROJECT_MAJOR_VERSION %EfiProjectMajorVersion% >> "%_include%"
  echo #define EFI_PROJECT_MINOR_VERSION %EfiProjectMinorVersion% >> "%_include%"
  echo #define EFI_PROJECT_UPDATE_VERSION %EfiProjectUpdateVersion% >> "%_include%"
  echo #define EFI_PROJECT_VERSION_TAG L"%EfiProjectVersionTag%">> "%_include%"
  echo #define EFI_PROJECT_VERSION_HASH L"%EfiProjectVersionHash%">> "%_include%"
  echo #define EFI_PROJECT_VERSION L"%EfiProjectVersion%">> "%_include%"
  echo #define EFI_PROJECT_NAME L"%EfiProjectName%">> "%_include%"
  echo #define EFI_PROJECT_ARCH L"%EfiProjectShortArch%">> "%_include%"
  if not "%EfiProjectArch%" == "" echo #define EFI_ARCH_%EfiProjectArch%>> "%_include%"
  if "%EfiProjectDebug%" == "1" echo #define EFI_DEBUG>> "%_include%"
  if "%EfiMemoryVirtual%" == "1" echo #define EFI_MEMORY_VIRTUAL>> "%_include%"
  if "%EfiMemoryVirtualFirmwareSafe%" == "1" echo #define EFI_MEMORY_VIRTUAL_FIRMWARE_SAFE>> "%_include%"
  if "%EfiSerialDisable%" == "1" echo #define EFI_SERIAL_DISABLE>> "%_include%"
  echo #endif >> "%_include%"
)

endlocal
