setlocal enableextensions enabledelayedexpansion

if "%~1" == "" exit 1
if not exist "%~1" exit 2

call:pathname "%~f1" _intpath "%~f2"
set _dir=%EfiBuildStage%\%~3\%_intpath%
call:fullpath "%_dir%" _dir
mkdir "%_dir%" 1>NUL 2>&1
set _intpath=%EfiBuildStage%\Include\%~4\%_intpath%
mkdir "%_intpath%" 1>NUL 2>&1
call:fullpath "%_intpath%\%~nx1.h" _path
echo Creating resource "%_path%" from "%~f1" ...

set _resource=
call:stripname "%~nx1" _resource
if not defined _resource endlocal & exit 1

pushd "%_dir%"
copy /y /b "%~fp1" "%~nx1" 1>NUL 2>&1
"%EfiProjectBuildTools%\xxd.exe" -i "%~nx1" "%~nx1.c"
echo // This file was autogenerated by the resource tool> "%_path%"
echo #ifndef __%_resource%_HEADER__>> "%_path%"
echo #define __%_resource%_HEADER__>> "%_path%"
echo extern unsigned char %_resource%[];>> "%_path%"
echo extern unsigned int  %_resource%_len;>> "%_path%"
echo #endif>> "%_path%"
cl /nologo /c "%~nx1.c"
popd

endlocal
goto:eof

:stripname
  setlocal enableextensions enabledelayedexpansion
  set _resource=
  set _continue=
  for /f "tokens=1,* delims=.,;'`-+*~[]{}@#$%%^^^&^<^>^|^=^(^)^!^ " %%a in ("%~1") do (
    set _resource=%%a_%%b
    set _continue=%%b
  )
  if defined _continue (
    call:stripname %_resource% %2
  ) else (
    set _resource=!_resource:~0,-1!
  )
  endlocal & set %2=%_resource%
goto:eof

:fullpath
  setlocal enableextensions enabledelayedexpansion
  set __path=%~f1
  endlocal & set %2=%__path%
goto:eof

:pathname
  setlocal enableextensions enabledelayedexpansion
  if not "%~3" == "" (
    set _source=%~f3
  ) else (
    set _source=%EfiProjectSource%
  )
  call:dirname "%~1" _dir
  if /i "%_dir%" == "%_source%" (
    endlocal
    goto:eof
  )
  if /i "%_dir%\" == "%_source%" (
    endlocal
    goto:eof
  )
  if /i "%_dir%\" == "%~d1" (
    endlocal
    goto:eof
  )
  if /i "%_dir%" == "%~d1" (
    endlocal
    goto:eof
  )
  call:filename "%_dir%" _file
  set __path=%_file%\%__path%
  call:pathname "%_dir%" __path "%_source%"
  :endpath
    endlocal & set %2=%__path%
goto:eof

:dirname
  setlocal enableextensions enabledelayedexpansion
  set _dir=%~dp1
  set _dir=%_dir:~0,-1%
  endlocal & set %2=%_dir%
goto:eof

:filename
  setlocal enableextensions enabledelayedexpansion
  set _file=%~nx1
  endlocal & set %2=%_file%
goto:eof
